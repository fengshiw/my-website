import React, { useState, useEffect, useRef } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import { Table, TableHead, TableHeader, TableBody, TableRow, TableCell } from "@/components/ui/table";
import Papa from "papaparse";
import * as XLSX from "xlsx";

export default function TableSearchDashboard() {
  const [tables, setTables] = useState(() => {
    const saved = localStorage.getItem("tables");
    return saved ? JSON.parse(saved) : [];
  });
  const [activeTab, setActiveTab] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [showList, setShowList] = useState(true);
  const [hiddenHeaders, setHiddenHeaders] = useState({});
  const [settingsTable, setSettingsTable] = useState(null);
  const [headerMenu, setHeaderMenu] = useState({ visible: false, x: 0, y: 0, tableName: '', index: null });
  const isDragging = useRef(false);

  useEffect(() => {
    localStorage.setItem("tables", JSON.stringify(tables));
  }, [tables]);

  const readFile = (file, callback) => {
    const reader = new FileReader();
    const ext = file.name.split(".").pop().toLowerCase();

    reader.onload = (event) => {
      let data;
      if (["csv", "tsv", "txt"].includes(ext)) {
        Papa.parse(event.target.result, {
          complete: (results) => {
            data = results.data;
            if (data && data.length > 0) callback(processData(file.name, data));
          },
        });
      } else if (["xls", "xlsx"].includes(ext)) {
        const workbook = XLSX.read(event.target.result, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        data = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
        if (data && data.length > 0) callback(processData(file.name, data));
      }
    };

    if (["xls", "xlsx"].includes(ext)) {
      reader.readAsBinaryString(file);
    } else {
      reader.readAsText(file);
    }
  };

  const processData = (name, data) => {
    const headers = autoDetectHeaders(data);
    const trimmedData = data.slice(headers.index + 1).filter(row => row.length > 0);
    return {
      name,
      headers: headers.values,
      data: trimmedData,
      enabled: true,
      id: `${name}_${Date.now()}`
    };
  };

  const autoDetectHeaders = (data) => {
    for (let i = 0; i < Math.min(5, data.length); i++) {
      const row = data[i];
      if (row && row.length >= 2 && row.filter((cell) => typeof cell === "string" && cell.trim() !== "").length >= 2) {
        return { index: i, values: row };
      }
    }
    return { index: 0, values: data[0] || [] };
  };

  const toggleHeader = (tableName, index) => {
    setHiddenHeaders((prev) => {
      const updated = { ...prev };
      updated[tableName] = updated[tableName] || {};
      updated[tableName][index] = !updated[tableName][index];
      return updated;
    });
    setHeaderMenu({ visible: false, x: 0, y: 0, tableName: '', index: null });
  };

  const handleFiles = (e) => {
    const files = Array.from(e.target.files);
    files.forEach((file) => {
      readFile(file, (table) => {
        setTables((prev) => [...prev, table]);
        if (!activeTab) setActiveTab(table.name);
      });
    });
  };

  const removeTableById = (id) => {
    setTables((prev) => prev.filter((t) => t.id !== id));
  };

  return (
    <div className="p-6 space-y-6 relative">
      {/* ... UI组件已省略，这里保持原始代码功能一致 */}
    </div>
  );
}
