<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>滤芯搜索系统</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #2c3e50; color: white; padding: 20px; text-align: center; font-size: 20px; }
    .container { max-width: 1000px; margin: 30px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .upload-zone { border: 2px dashed #aaa; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px; }
    .upload-zone.dragover { border-color: #4CAF50; background: #f0fff0; color: #4CAF50; }
    .file-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin: 8px 0; }
    .file-name { cursor: pointer; border-bottom: 1px dashed #666; }
    .file-row button, .file-row input[type="checkbox"] { padding: 4px 10px; }
    .file-actions { margin-left: auto; display: flex; gap: 10px; align-items: center; }
    #searchBox { width: 60%; display: block; margin: 20px auto; padding: 10px; font-size: 16px; }
    #count { text-align: center; font-weight: bold; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 14px; text-align: left; }
    th { background-color: #eee; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>
<header>滤芯搜索系统</header>
<div class="container">
  <div class="upload-zone" id="uploadZone">上传主文件或 <input type="file" id="uploadFile" multiple></div>
  <div id="mainFileList"></div>
  <div class="upload-zone" id="stockZone">上传库存文件（支持多个）或 <input type="file" id="stockFile" multiple></div>
  <div id="stockFileList"></div>
  <input type="text" id="searchBox" placeholder="输入关键词搜索...">
  <div id="count"></div>
  <div id="results"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
let mainFiles = {}, stockFiles = {};
const $ = id => document.getElementById(id);
const norm = s => s.toString().toLowerCase().replace(/[^a-z0-9一-龥]/g, "");

function saveFilesToStorage() {
  localStorage.setItem('mainFiles', JSON.stringify(mainFiles));
  localStorage.setItem('stockFiles', JSON.stringify(stockFiles));
}

function loadFilesFromStorage() {
  const m = localStorage.getItem('mainFiles'), s = localStorage.getItem('stockFiles');
  if (m) mainFiles = JSON.parse(m);
  if (s) stockFiles = JSON.parse(s);
  renderFileList("mainFileList", mainFiles);
  renderFileList("stockFileList", stockFiles, true);
}

function parseExcel(file, cb) {
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
    const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
    const head = raw[1], rows = raw.slice(2);
    const data = rows.map(r => Object.fromEntries(head.map((h, i) => [h, r[i] || ""])));
    cb(file.name, data);
  };
  r.readAsArrayBuffer(file);
}

function renderFileList(id, files, isStock = false) {
  const box = $(id);
  box.innerHTML = "";
  Object.entries(files).forEach(([name, rows]) => {
    const html = `
      <div class="file-row">
        <span class="file-name" contenteditable="true" onblur="renameDirect(this,'${name}','${id}')">${name}</span>
        ${!isStock ? `<input type="checkbox" id="check_${name.replace(/\W/g, "_")}" checked>` : ""}
        <div class="file-actions">
          <button onclick="exportFile('${name}','${id}')">导出</button>
          <button onclick="deleteFile('${name}','${id}')">删除</button>
        </div>
      </div>`;
    box.insertAdjacentHTML("beforeend", html);
  });
}

function renameDirect(el, oldName, id) {
  const newName = el.innerText.trim();
  if (!newName || newName === oldName) return;
  const files = id === "mainFileList" ? mainFiles : stockFiles;
  if (files[newName]) return alert("已有同名文件");
  files[newName] = files[oldName];
  delete files[oldName];
  saveFilesToStorage();
  renderFileList(id, files, id === "stockFileList");
}

function exportFile(name, id) {
  const data = (id === "mainFileList" ? mainFiles : stockFiles)[name];
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  XLSX.writeFile(wb, name + ".xlsx");
}

function deleteFile(name, id) {
  const files = id === "mainFileList" ? mainFiles : stockFiles;
  delete files[name];
  saveFilesToStorage();
  renderFileList(id, files, id === "stockFileList");
}

$("uploadFile").onchange = e => {
  [...e.target.files].forEach(f => {
    if (f.name.endsWith(".xls") || f.name.endsWith(".xlsx"))
      parseExcel(f, (n, d) => { mainFiles[n] = d; saveFilesToStorage(); renderFileList("mainFileList", mainFiles); });
  });
};

$("stockFile").onchange = e => {
  [...e.target.files].forEach(f => {
    if (f.name.endsWith(".xls") || f.name.endsWith(".xlsx"))
      parseExcel(f, (n, d) => { stockFiles[n] = d; saveFilesToStorage(); renderFileList("stockFileList", stockFiles, true); });
  });
};

["uploadZone", "stockZone"].forEach(id => {
  const isStock = id === "stockZone";
  $(id).ondragover = e => (e.preventDefault(), e.currentTarget.classList.add("dragover"));
  $(id).ondragleave = e => e.currentTarget.classList.remove("dragover");
  $(id).ondrop = e => {
    e.preventDefault(); e.currentTarget.classList.remove("dragover");
    [...e.dataTransfer.files].forEach(f => {
      if (f.name.endsWith(".xls") || f.name.endsWith(".xlsx")) {
        parseExcel(f, (n, d) => {
          const target = isStock ? stockFiles : mainFiles;
          target[n] = d;
          saveFilesToStorage();
          renderFileList(isStock ? "stockFileList" : "mainFileList", target, isStock);
        });
      }
    });
  };
});

$("searchBox").oninput = e => {
  const q = norm(e.target.value.trim());
  if (!q) return $("results").innerHTML = $("count").textContent = "";
  const result = [];
  const stockSet = new Set(Object.values(stockFiles).flat().map(r => norm(Object.values(r)[0])));
  Object.entries(mainFiles).forEach(([n, rows]) => {
    if (!$(`check_${n.replace(/\W/g,"_")}`)?.checked) return;
    rows.forEach(r => {
      if (Object.values(r).some(v => norm(v).includes(q))) {
        const row = {...r};
        row["库存"] = stockSet.has(norm(Object.values(r)[0])) ? "✅" : "❌";
        result.push(row);
      }
    });
  });
  $("count").textContent = `共 ${result.length} 条`;
  $("results").innerHTML = result.length ? render(result) : "";
};

function render(data) {
  const keys = Object.keys(data[0] || {});
  const rename = k => k === "主计量单位" ? "单位" : k === "销售报价" ? "价格" : k === "物品分类" ? "分类" : k;
  let html = "<table><tr>" + keys.map(k => `<th>${rename(k)}</th>`).join("") + "</tr>";
  return html + data.map(r => "<tr>" + keys.map(k => `<td>${r[k]||""}</td>`).join("") + "</tr>").join("") + "</table>";
}

loadFilesFromStorage();
</script>
</body>
</html>
