<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ»¤èŠ¯ç®¡ç†</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
    .container { max-width: 960px; margin: 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #fileManagerToggle { margin: 0 auto 10px; display: block; padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #fileManager { max-height: 0; overflow: hidden; transition: all 0.4s ease; opacity: 0; margin-bottom: 20px; }
    #fileManager.open { max-height: 1000px; opacity: 1; }
    .file-row { display: flex; align-items: center; margin-bottom: 10px; }
    .file-name { flex-grow: 1; font-weight: bold; }
    .file-row input { margin-left: 10px; padding: 4px; }
    .file-row button { margin-left: 6px; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
    .load-btn { background: #2196f3; color: #fff; }
    .export-btn { background: #9c27b0; color: #fff; }
    .rename-btn { background: #ff9800; color: #fff; }
    .delete-btn { background: #f44336; color: #fff; }
    #uploadZone { border: 2px dashed #aaa; padding: 40px; text-align: center; color: #888; margin-bottom: 20px; border-radius: 8px; }
    #uploadZone.dragover { border-color: #4CAF50; background: #f0fff0; color: #4CAF50; }
    #searchBox { display: block; margin: 0 auto 10px; padding: 10px; font-size: 16px; width: 60%; border-radius: 5px; border: 1px solid #ccc; }
    #count { text-align: center; font-weight: bold; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; background-color: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; text-align: left; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even){background-color: #f9f9f9;}
    tr:hover {background-color: #f1f1f1;}
  </style>
</head>
<body>
  <header>æ»¤èŠ¯æ•°æ®ç®¡ç†ç³»ç»Ÿ<div id="currentFile">å½“å‰æ–‡ä»¶ï¼šæœªé€‰æ‹©</div></header>
  <div class="container">
    <button id="fileManagerToggle">ğŸ“ ç®¡ç†æ–‡ä»¶</button>
    <div id="fileManager"></div>
    <div id="uploadZone">æ‹–æ‹½ Excel æ–‡ä»¶ä¸Šä¼  æˆ– <input type="file" id="uploadFile" accept=".xlsx"></div>
    <input type="text" id="searchBox" placeholder="æœç´¢...">
    <div id="count"></div>
    <div id="results"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script>
    let data = [], currentKey = "", PREFIX = "xlsx_";
    const $ = id => document.getElementById(id);
    const norm = str => str.toString().toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/gi, '');
    function fuzzySearch(q) {
      const clean = norm(q);
      return data.filter(item => Object.values(item).some(v => v && norm(v).includes(clean)));
    }
    function renderTable(results) {
      const keys = Object.keys(results[0] || {});
      let html = "<table><tr>" + keys.map(k => `<th>${k}</th>`).join("") + "</tr>";
      return html + results.map(row => "<tr>" + keys.map(k => `<td>${row[k]||""}</td>`).join("") + "</tr>").join("") + "</table>";
    }
    function renderResults(res) {
      $("count").textContent = res.length ? `å…± ${res.length} æ¡` : "";
      $("results").innerHTML = res.length ? renderTable(res) : "";
    }
    function saveFile(name, content) { localStorage.setItem(PREFIX + name, JSON.stringify(content)); }
    function loadFile(name) {
      const raw = localStorage.getItem(PREFIX + name); if (!raw) return;
      data = JSON.parse(raw); currentKey = name;
      $("currentFile").textContent = "å½“å‰æ–‡ä»¶ï¼š" + name;
      renderResults([]);
    }
    function updateFileManager() {
      const list = $("fileManager"); list.innerHTML = "";
      Object.keys(localStorage).filter(k => k.startsWith(PREFIX)).forEach(k => {
        const name = k.slice(PREFIX.length), rows = JSON.parse(localStorage[k]);
        const row = document.createElement("div");
        row.className = "file-row";
        row.innerHTML = `<span class="file-name">${name}ï¼ˆ${rows.length}æ¡ï¼‰</span>
          <input placeholder="æ–°åç§°">
          <button class="load-btn">åŠ è½½</button>
          <button class="export-btn">å¯¼å‡º</button>
          <button class="rename-btn">é‡å‘½å</button>
          <button class="delete-btn">åˆ é™¤</button>`;
        const [input, load, exp, ren, del] = row.querySelectorAll("input,button");
        load.onclick = () => loadFile(name);
        exp.onclick = () => {
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
          XLSX.writeFile(wb, `${name}.xlsx`);
        };
        ren.onclick = () => {
          const newName = input.value.trim();
          if (!newName) return;
          localStorage.setItem(PREFIX + newName, localStorage[k]);
          localStorage.removeItem(k);
          if (currentKey === name) currentKey = newName;
          $("currentFile").textContent = "å½“å‰æ–‡ä»¶ï¼š" + currentKey;
          updateFileManager();
        };
        del.onclick = () => {
          localStorage.removeItem(k);
          if (currentKey === name) {
            data = []; currentKey = "";
            $("results").innerHTML = ""; $("currentFile").textContent = "å½“å‰æ–‡ä»¶ï¼šæœªé€‰æ‹©";
          }
          updateFileManager();
        };
        list.appendChild(row);
      });
    }
    $("searchBox").oninput = e => {
      const q = e.target.value.trim();
      renderResults(q ? fuzzySearch(q) : []);
    };
    $("uploadFile").onchange = e => handleFile(e.target.files[0]);
    $("uploadZone").ondragover = e => (e.preventDefault(), $("uploadZone").classList.add("dragover"));
    $("uploadZone").ondragleave = () => $("uploadZone").classList.remove("dragover");
    $("uploadZone").ondrop = e => {
      e.preventDefault(); $("uploadZone").classList.remove("dragover");
      const f = e.dataTransfer.files[0]; if (f && f.name.endsWith(".xlsx")) handleFile(f);
    };
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(sheet, {header: 1});
        const head = raw[1], rows = raw.slice(2);
        data = rows.map(r => Object.fromEntries(head.map((h, i) => [h, r[i] || ""])));
        const name = file.name.replace(".xlsx", "");
        saveFile(name, data);
        currentKey = name;
        $("currentFile").textContent = "å½“å‰æ–‡ä»¶ï¼š" + name;
        renderResults([]);
        updateFileManager();
      };
      reader.readAsArrayBuffer(file);
    }
    $("fileManagerToggle").onclick = () => {
      $("fileManager").classList.toggle("open");
      updateFileManager();
    };
    window.onload = () => {
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith(PREFIX)) {
          const name = k.slice(PREFIX.length);
          if (loadFile(name)) break;
        }
      }
    };
  </script>
</body>
</html>
